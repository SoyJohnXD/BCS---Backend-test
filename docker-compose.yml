version: "3.8"

services:
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile.dev
    container_name: api-gateway
    ports:
      - "3000:3000"
    volumes:
      - ./api-gateway:/app
      - /app/node_modules
    command: npm run start:dev
    depends_on:
      - auth-service
      - product-service
      - onboarding-service
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL}
      - ONBOARDING_SERVICE_URL=${ONBOARDING_SERVICE_URL}

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile.dev
    container_name: auth-service
    volumes:
      - ./auth-service:/app
      - /app/node_modules
    command: npm run start:dev
    depends_on:
      - db-auth
    environment:
      - DATABASE_HOST=${AUTH_DATABASE_HOST}
      - DATABASE_PORT=${AUTH_DATABASE_PORT}
      - DATABASE_USER=${AUTH_DATABASE_USER}
      - DATABASE_PASSWORD=${AUTH_DATABASE_PASSWORD}
      - DATABASE_NAME=${AUTH_DATABASE_NAME}
      - JWT_SECRET=${JWT_SECRET}

  product-service:
    build:
      context: ./product-service
      dockerfile: Dockerfile.dev
    container_name: product-service
    volumes:
      - ./product-service:/app
      - /app/node_modules
    command: npm run start:dev
    depends_on:
      - db-products
      - redis-cache
    environment:
      - DATABASE_HOST=${PRODUCT_DATABASE_HOST}
      - DATABASE_PORT=${PRODUCT_DATABASE_PORT}
      - DATABASE_USER=${PRODUCT_DATABASE_USER}
      - DATABASE_PASSWORD=${PRODUCT_DATABASE_PASSWORD}
      - DATABASE_NAME=${PRODUCT_DATABASE_NAME}
      - REDIS_HOST=${PRODUCT_REDIS_HOST}
      - REDIS_PORT=${PRODUCT_REDIS_PORT}

  onboarding-service:
    build:
      context: ./onboarding-service
      dockerfile: Dockerfile.dev
    container_name: onboarding-service
    volumes:
      - ./onboarding-service:/app
      - /app/node_modules
    command: npm run start:dev
    depends_on:
      - db-onboarding
    environment:
      - DATABASE_HOST=${ONBOARDING_DATABASE_HOST}
      - DATABASE_PORT=${ONBOARDING_DATABASE_PORT}
      - DATABASE_USER=${ONBOARDING_DATABASE_USER}
      - DATABASE_PASSWORD=${ONBOARDING_DATABASE_PASSWORD}
      - DATABASE_NAME=${ONBOARDING_DATABASE_NAME}
      - VALIDATION_SERVICE_URL=${VALIDATION_SERVICE_URL}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

  validation-service:
    build:
      context: ./validation-service
      dockerfile: Dockerfile.dev
    container_name: validation-service
    volumes:
      - ./validation-service:/app
      - /app/node_modules
    command: npm run start:dev
    environment:
      - ONBOARDING_SERVICE_URL=${ONBOARDING_SERVICE_URL}

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    command: npm run dev
    ports:
      - "3001:3000"
    environment:
      - API_GATEWAY_URL=${API_GATEWAY_URL}
      - NEXT_PUBLIC_CLIENT_URL=http://localhost:3001

  db-auth:
    image: postgres:14-alpine
    container_name: db-auth
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${AUTH_POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - auth-data:/var/lib/postgresql/data

  db-products:
    image: postgres:14-alpine
    container_name: db-products
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${PRODUCT_POSTGRES_DB}
    ports:
      - "5433:5432"
    volumes:
      - products-data:/var/lib/postgresql/data

  db-onboarding:
    image: postgres:14-alpine
    container_name: db-onboarding
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${ONBOARDING_POSTGRES_DB}
    ports:
      - "5434:5432"
    volumes:
      - onboarding-data:/var/lib/postgresql/data

  redis-cache:
    image: redis:6-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"

volumes:
  auth-data:
  products-data:
  onboarding-data:
